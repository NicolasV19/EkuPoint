<!-- templates/registration/register.html -->
{% load static %}
<!DOCTYPE html>
<html>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<head>
    <title>Register</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .error { color: red; font-size: 0.9em; }
        .success { color: green; font-size: 0.9em; }
        .form-group { margin-bottom: 1rem; margin-right: 70px; }
        input { display: block; width: 300px; padding: 0.5rem; margin-top: 0.25rem; }
        button { padding: 0.75rem 2rem; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .form-container { max-width: 750px; margin: 2rem auto; padding: 2rem; border: 1px solid #ddd; }
    </style>
</head>
<body style="font-family: Figtree, sans-serif;">
    <div class="form-container">
        <h2>Create Account</h2>
        
        <div id="message-container"></div>
                    <table>
            <tr>
            <td style="vertical-align: top;">
        
        <form 
            hx-post="{% url 'register' %}" 
            hx-target="#message-container"
            hx-swap="innerHTML"
            hx-trigger="submit"
            id="register-form"
        >
            {% csrf_token %}

            <div class="form-group">
                <label for="id_username">Username:</label>
                <input type="text" name="username" id="id_username" required>
                <div id="username-errors" class="error"></div>
            </div>
            
            <div class="form-group">
                <label for="id_first_name">First Name:</label>
                <input type="text" name="first_name" id="id_first_name" required>
                <div id="first_name-errors" class="error"></div>
            </div>

            <div class="form-group">
                <label for="id_last_name">Last Name:</label>
                <input type="text" name="last_name" id="id_last_name" required>
                <div id="last_name-errors" class="error"></div> 
            </div>
            
            <!--
            <div class="form-group">
                <label for="id_email">Email:</label>
                <input type="email" name="email" id="id_email" required>
                <div id="email-errors" class="error"></div>
            </div>
            -->
            
            <div class="form-group">
                <label for="id_password1">Password:</label>
                <input type="password" name="password1" id="id_password1" required>
                <div id="password1-errors" class="error"></div>
            </div>
            
            <div class="form-group">
                <label for="id_password2">Confirm Password:</label>
                <input type="password" name="password2" id="id_password2" required>
                <div id="password2-errors" class="error"></div>
            </div>
            </td>
            <td style="vertical-align: top; float: right; ">

            <div class="form-group">
                <label for="id_nim">NIM:</label>
                <input type="text" name="nim" id="id_nim" required>
                <div id="nim-errors" class="error"></div>
            </div>

            <div class="form-group">
{{ form.prodi.label_tag }}

    <!-- 
      This will render the entire <select> dropdown, 
      complete with all the <option> tags from your database.
    -->
    {{ form.prodi }}
    <div class-="error">
        {{ form.prodi.errors }}
    </div>
            </div>

            <div class="form-group">
{{ form.angkatan.label_tag }}


    {{ form.angkatan }}


    <div class-="error">
        {{ form.angkatan.errors }}
    </div>
            </div>
                                </td>
        </table>
        </form>
            
            <div style="align-content: center; display: flex; flex-wrap: wrap; ">
            <button type="submit" id="submit-btn" style="background-color: #700000ff; font-family: Figtree, sans-serif; border-radius: 0.7rem; ">Register</button>
            </div>


    </div>

    <script>
        // Handle form submission response
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.target.id === 'register-form') {
                const response = JSON.parse(event.detail.xhr.responseText);
                
                // Clear previous errors
                document.querySelectorAll('.error').forEach(el => el.innerHTML = '');
                document.getElementById('message-container').innerHTML = '';
                
                if (response.success) {
                    // Show success message and redirect
                    document.getElementById('message-container').innerHTML = 
                        `<div class="success">${response.message}</div>`;
                    
                    setTimeout(() => {
                        window.location.href = response.redirect_url;
                    }, 1500);
                    
                } else {
                    // Display validation errors
                    for (const field in response.errors) {
                        const errorElement = document.getElementById(`${field}-errors`);
                        if (errorElement) {
                            errorElement.innerHTML = response.errors[field]
                                .map(error => error.message)
                                .join('<br>');
                        }
                    }
                    
                    // Show general error message
                    if (Object.keys(response.errors).length > 0) {
                        document.getElementById('message-container').innerHTML = 
                            '<div class="error">Please correct the errors below.</div>';
                    }
                }
            }
        });

        // Real-time validation (optional)
        document.getElementById('id_email').addEventListener('blur', function() {
            const email = this.value;
            if (email) {
                htmx.ajax('GET', `/check-email/?email=${email}`, '#email-errors');
            }
        });
    </script>
</body>
</html>